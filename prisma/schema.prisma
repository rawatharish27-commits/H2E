// Help2Earn - Production-Grade PostgreSQL Schema
// Hyperlocal Task & Earning Network (20km radius)
// Referral growth + Real activity based earning - No MLM, No Fake Guarantee

generator client {
  provider = "prisma-client-js"
}

// SQLite Database for development
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== AREA SYSTEM ====================

// Area Activation - Track area stats for activation
model Area {
  id       String @id @default(cuid())
  areaCode String @unique // 20km zone identifier
  areaName String // e.g., "Dehradun Central"

  // Activation Requirements
  registeredUsers Int @default(0) // Need 50 minimum
  weeklyTasks     Int @default(0) // Need 10 minimum
  taskProviders   Int @default(0) // Need 5 minimum

  // Status
  isActive    Boolean   @default(false) // Active when all requirements met
  activatedAt DateTime?

  // Leader Slots (max 3 per area)
  maxLeaderSlots Int @default(3)
  currentLeaders Int @default(0)

  // Stats
  totalUsers    Int   @default(0)
  totalTasks    Int   @default(0)
  totalEarnings Float @default(0)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leaders Leader[]
  users   User[]

  @@index([areaCode])
  @@index([isActive])
}

// ==================== USER SYSTEM ====================

// User model - Both client and helper
model User {
  id     String  @id @default(cuid())
  phone  String  @unique
  name   String?
  avatar String?
  email  String?

  // Subscription
  paymentActive    Boolean   @default(false)
  activeTill       DateTime?
  subscriptionType String    @default("BASIC") // BASIC, PREMIUM, LIFETIME

  // Trust & Safety
  trustScore    Int   @default(50)
  noShowCount   Int   @default(0)
  noShowStrikes Int   @default(0) // 3 strikes = invisible
  reportCount   Int   @default(0)
  helpfulCount  Int   @default(0) // Number of successful helps - FOR LEADER UNLOCK
  ratingSum     Int   @default(0) // Sum of all ratings
  ratingCount   Int   @default(0) // Number of ratings
  avgRating     Float @default(0) // Calculated average rating - FOR LEADER UNLOCK

  // Location (foreground only)
  lat               Float?
  lng               Float?
  locationUpdatedAt DateTime?
  lastActiveAt      DateTime  @default(now())
  areaCode          String? // 20km zone identifier

  // Status - Security Enhanced
  isBlocked      Boolean   @default(false)
  isBanned       Boolean   @default(false)
  isShadowBanned Boolean   @default(false) // Silent invisible
  isFlagged      Boolean   @default(false) // Under review
  blockedTill    DateTime?

  // ==================== ANTI-FRAUD FIELDS ====================
  // Device binding
  deviceFingerprint String? @unique // Primary device ID

  // IP tracking
  registeredIP String? // IP at registration
  lastLoginIP  String? // Last login IP
  ipHistory    String? // JSON array of recent IPs

  // UPI/Bank duplicate check
  linkedUPIs String? // JSON array of linked UPI IDs

  // Multi-account flags
  suspectedMultiAccount Boolean @default(false)
  linkedAccounts        String? // JSON array of suspected linked account IDs

  // ==================== REFERRAL SYSTEM ====================
  referralCode    String? @unique
  referredBy      String?
  referralCount   Int     @default(0)
  activeReferrals Int     @default(0) // Referrals who completed first task - FOR LEADER UNLOCK
  hasSharedReferral Boolean @default(false) // User must share before login

  // Referral earnings (₹5 per active referral)
  referralEarnings  Float @default(0) // Total earned from referrals
  pendingEarnings   Float @default(0) // Earnings waiting 48hr unlock
  withdrawnEarnings Float @default(0) // Total withdrawn

  // Minimum withdrawal: ₹200
  canWithdraw Boolean @default(false)

  // ==================== LEADER SYSTEM ====================
  isLeader           Boolean @default(false)
  leaderLevel        String  @default("NONE") // NONE, BRONZE, SILVER, GOLD, AMBASSADOR
  referredByLeaderId String? // If this user was referred by a leader

  // Leader unlock progress (for UI)
  tasksProgress     Int   @default(0) // Progress towards 10 tasks
  ratingProgress    Float @default(0) // Progress towards 4.5 rating
  referralsProgress Int   @default(0) // Progress towards 20 active referrals

  // KYC Status
  kycVerified    Boolean   @default(false)
  kycSubmittedAt DateTime?

  // Badges & Status
  badges      String? // JSON array of badge IDs
  statusBadge String  @default("NEW") // NEW, ACTIVE, TRUSTED, EXPERT, LEADER

  // Preferences
  darkMode         Boolean @default(false)
  language         String  @default("hi") // hi, en
  notifications    Boolean @default(true)
  locationEnabled  Boolean @default(true) // User can toggle
  showProfile      Boolean @default(true)
  crossAreaEnabled Boolean @default(false) // See 30km tasks

  // WhatsApp Notification Preferences
  whatsappEnabled   Boolean @default(false)
  whatsappNumber    String?
  quietHoursStart   String? // e.g., "22:00"
  quietHoursEnd     String? // e.g., "07:00"
  notificationTypes String? // JSON array of problem types to notify for

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  area                  Area?                   @relation(fields: [areaCode], references: [areaCode])
  problems              Problem[]
  payments              Payment[]
  feedbacks             Feedback[]
  reports               Report[]                @relation("Reporter")
  reportedBy            Report[]                @relation("Reported")
  sessions              Session[]
  referrals             Referral[]              @relation("Referrer")
  referredUsers         Referral[]              @relation("Referred")
  achievements          UserAchievement[]
  notificationsList     Notification[]
  deviceBindings        DeviceBinding[]
  securityAudits        SecurityAudit[]
  adminRoles            AdminAssignment[]
  whatsappNotifications WhatsAppNotification[]
  leaderProfile         Leader?
  referredByLeader      Leader?                 @relation("LeaderReferrals", fields: [referredByLeaderId], references: [id])
  starterTasks          StarterTaskCompletion[]

  @@index([phone])
  @@index([trustScore])
  @@index([paymentActive])
  @@index([referralCode])
  @@index([isShadowBanned])
  @@index([isFlagged])
  @@index([whatsappEnabled])
  @@index([whatsappNumber])
  @@index([isLeader])
  @@index([areaCode])
  @@index([deviceFingerprint])
  @@index([registeredIP])
}

// ==================== SESSION & SECURITY ====================

// Session model for JWT management
model Session {
  id                String   @id @default(cuid())
  userId            String
  token             String   @unique
  deviceInfo        String?
  deviceFingerprint String? // For device binding
  ipAddress         String?
  userAgent         String?
  isSuspicious      Boolean  @default(false)
  expiresAt         DateTime
  createdAt         DateTime @default(now())
  lastUsedAt        DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([deviceFingerprint])
}

// Device Binding - One device per account (soft binding)
model DeviceBinding {
  id                 String   @id @default(cuid())
  userId             String
  deviceFingerprint  String   @unique // Hash of device info
  deviceName         String?
  deviceType         String? // mobile, tablet, desktop
  osInfo             String?
  firstSeenAt        DateTime @default(now())
  lastUsedAt         DateTime @default(now())
  isPrimary          Boolean  @default(false)
  isBlocked          Boolean  @default(false)
  suspiciousActivity Int      @default(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([deviceFingerprint])
}

// ==================== TASK SYSTEM ====================

// Problem/Help Request model
model Problem {
  id         String @id @default(cuid())
  postedById String

  // Classification
  type      String // EMERGENCY, TIME_ACCESS, RESOURCE_RENT, PLATFORM_TASK
  category  String? // puncture, charging, bike_rent, etc.
  riskLevel String  @default("LOW") // LOW, MEDIUM, HIGH

  // Content
  title       String
  description String
  offerPrice  Float?
  image       String? // Problem photo URL (base64 or uploaded)

  // Location
  lat      Float
  lng      Float
  address  String?
  areaCode String? // For area tracking

  // Trust requirement
  minTrustRequired Int @default(40)

  // Status
  status String @default("OPEN") // OPEN, IN_PROGRESS, CLOSED, CANCELLED

  // Helper info
  acceptedById String?
  acceptedAt   DateTime?

  // No-show tracking
  helperArrived  Boolean?
  noShowReported Boolean  @default(false)

  // Content moderation
  isAutoHidden     Boolean @default(false) // Hidden due to content filter
  moderationStatus String  @default("APPROVED") // PENDING, APPROVED, REJECTED
  moderationReason String?

  // Metadata
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime?
  closedAt  DateTime?

  // Relations
  postedBy     User          @relation(fields: [postedById], references: [id])
  feedbacks    Feedback[]
  reports      Report[]
  chatMessages ChatMessage[]

  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([lat, lng])
  @@index([isAutoHidden])
  @@index([areaCode])
}

// ==================== STARTER / PLATFORM TASKS ====================

// Starter Tasks - For new users to earn while building supply
model StarterTask {
  id String @id @default(cuid())

  // Task Info
  title         String
  titleHi       String?
  description   String
  descriptionHi String?
  icon          String // Emoji or icon name

  // Task Type
  type     String // SURVEY, FEEDBACK, PROMOTION, VERIFICATION
  category String // LOCAL, PLATFORM, COMMUNITY

  // Reward
  rewardAmount Float @default(5) // ₹5-20 per task

  // Requirements
  areaRequired Boolean @default(false) // Needs area to be active
  kycRequired  Boolean @default(false)

  // Limits
  maxCompletions     Int @default(0) // 0 = unlimited
  currentCompletions Int @default(0)
  perUserLimit       Int @default(1) // How many times per user

  // Availability
  isActive Boolean @default(true)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  completions StarterTaskCompletion[]

  @@index([type])
  @@index([isActive])
}

// Starter Task Completion - Track who completed what
model StarterTaskCompletion {
  id     String @id @default(cuid())
  taskId String
  userId String

  // Status
  status String @default("COMPLETED") // COMPLETED, REWARDED

  // Reward
  rewardAmount Float
  rewardedAt   DateTime?

  // Metadata
  completedAt DateTime @default(now())

  // Relations
  task StarterTask @relation(fields: [taskId], references: [id])
  user User        @relation(fields: [userId], references: [id])

  @@unique([taskId, userId])
  @@index([userId])
  @@index([taskId])
}

// ==================== PAYMENT SYSTEM ====================

// Payment/Subscription model
model Payment {
  id     String @id @default(cuid())
  userId String

  amount Float  @default(49)
  status String @default("PENDING") // PENDING, APPROVED, REJECTED, REFUNDED

  // Payment gateway info
  paymentMethod   String? // UPI, RAZORPAY, MANUAL
  upiId           String?
  transactionRef  String?
  razorpayId      String?
  razorpayOrderId String?

  // Fraud detection
  isFraudSuspected     Boolean @default(false)
  fraudReason          String?
  previousPendingCount Int? // Count of previous pending payments

  // Admin approval
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?

  // SLA tracking
  approvalSLA Int     @default(240) // minutes (4 hours)
  slaBreached Boolean @default(false)

  // Period
  month       String // Format: "2024-01"
  daysGranted Int    @default(30)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([status])
  @@index([userId])
  @@index([createdAt])
  @@index([razorpayId])
  @@index([isFraudSuspected])
  @@index([upiId])
}

// ==================== REFERRAL SYSTEM ====================

// Referral model - Updated for ₹5 per active user
model Referral {
  id             String @id @default(cuid())
  referrerId     String
  referredUserId String
  code           String

  // Status
  status String @default("PENDING") // PENDING, VERIFIED, FIRST_TASK, REWARDED

  // Task completion tracking
  firstTaskCompleted Boolean   @default(false)
  firstTaskAt        DateTime?

  // Reward (₹5 per active user after first task)
  rewardAmount   Float     @default(5)
  rewardUnlockAt DateTime? // 48 hours after first task

  // Withdrawal
  isWithdrawable Boolean   @default(false)
  withdrawnAt    DateTime?

  createdAt DateTime @default(now())

  // Relations
  referrer     User @relation("Referrer", fields: [referrerId], references: [id])
  referredUser User @relation("Referred", fields: [referredUserId], references: [id])

  @@unique([referredUserId])
  @@index([referrerId])
  @@index([code])
  @@index([status])
  @@index([firstTaskCompleted])
}

// ==================== FEEDBACK & RATINGS ====================

// Feedback/Rating model
model Feedback {
  id         String @id @default(cuid())
  problemId  String
  fromUserId String
  toUserId   String

  // Rating 1-5
  rating Int

  // Optional comment
  comment String?

  // Helper arrived or no-show
  helperArrived Boolean @default(true)

  // Help duration in minutes
  duration Int?

  // Metadata
  createdAt DateTime @default(now())

  // Relations
  problem Problem @relation(fields: [problemId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [toUserId], references: [id])

  @@unique([problemId, fromUserId])
  @@index([toUserId])
}

// Report model (for incidents)
model Report {
  id        String  @id @default(cuid())
  problemId String?

  reporterId     String
  reportedUserId String

  reason      String
  description String?
  severity    String  @default("LOW") // LOW, MEDIUM, HIGH, CRITICAL

  // Admin action
  status      String    @default("PENDING") // PENDING, REVIEWED, ACTIONED, DISMISSED
  actionTaken String? // WARN, RESTRICT, SHADOW_BAN, BAN
  reviewedBy  String?
  reviewedAt  DateTime?

  createdAt DateTime @default(now())

  // Relations
  reporter     User     @relation("Reporter", fields: [reporterId], references: [id])
  reportedUser User     @relation("Reported", fields: [reportedUserId], references: [id])
  problem      Problem? @relation(fields: [problemId], references: [id])

  @@index([status])
  @@index([reportedUserId])
}

// ==================== AUTH & VERIFICATION ====================

// OTP Verification model (for login)
model OtpVerification {
  id        String   @id @default(cuid())
  phone     String
  otp       String
  verified  Boolean  @default(false)
  attempts  Int      @default(0)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([phone])
  @@index([expiresAt])
}

// ==================== GAMIFICATION ====================

// Badge/Achievement model
model Badge {
  id          String   @id @default(cuid())
  name        String
  description String
  icon        String
  category    String // TRUST, HELP, REFERRAL, SPECIAL, LEADER
  requirement String // JSON with requirements
  reward      String? // JSON with rewards
  createdAt   DateTime @default(now())

  achievements UserAchievement[]

  @@unique([name])
}

// User Achievement model
model UserAchievement {
  id       String   @id @default(cuid())
  userId   String
  badgeId  String
  earnedAt DateTime @default(now())
  notified Boolean  @default(false)

  user  User  @relation(fields: [userId], references: [id])
  badge Badge @relation(fields: [badgeId], references: [id])

  @@unique([userId, badgeId])
  @@index([userId])
}

// ==================== LEADER SYSTEM ====================

// Leader System - Area Leaders with commission (max 3 per area)
model Leader {
  id     String @id @default(cuid())
  userId String @unique

  // Area Info
  areaCode String
  areaId   String? // Reference to Area model

  // Leader Level
  level String @default("BRONZE") // BRONZE, SILVER, GOLD, AMBASSADOR

  // Unlock Requirements (must meet ALL)
  tasksCompleted  Int     @default(0) // Need 10
  avgRating       Float   @default(0) // Need 4.5+
  activeReferrals Int     @default(0) // Need 20
  kycVerified     Boolean @default(false)

  // Progress tracking
  tasksProgress     Int   @default(0) // /10
  ratingProgress    Float @default(0) // /4.5
  referralsProgress Int   @default(0) // /20

  // Connected Users (direct referrals)
  connectedUsers Int @default(0)

  // Commission Stats (0.5% on helps in area)
  totalCommission     Float @default(0)
  monthlyCommission   Float @default(0)
  pendingCommission   Float @default(0)
  withdrawnCommission Float @default(0)

  // Status
  isActive   Boolean   @default(true)
  isVerified Boolean   @default(false) // Unlocked status
  unlockedAt DateTime?

  // Slot management
  slotNumber Int? // 1, 2, or 3

  // Milestones
  bronzeUnlocked     Boolean @default(false)
  silverUnlocked     Boolean @default(false)
  goldUnlocked       Boolean @default(false)
  ambassadorUnlocked Boolean @default(false)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  leaderReferrals User[]             @relation("LeaderReferrals")
  commissions     LeaderCommission[]
  area            Area?              @relation(fields: [areaId], references: [id])

  @@index([areaCode])
  @@index([level])
  @@index([isActive])
  @@index([isVerified])
}

// Leader Commission - Track all commission transactions (0.5%)
model LeaderCommission {
  id       String @id @default(cuid())
  leaderId String

  // Commission Details
  helpId         String? // Reference to the completed help
  amount         Float
  commissionRate Float   @default(0.005) // 0.5%

  // Status
  status String @default("PENDING") // PENDING, CREDITED, WITHDRAWN

  // Metadata
  description String?
  createdAt   DateTime  @default(now())
  creditedAt  DateTime?

  // Relations
  leader Leader @relation(fields: [leaderId], references: [id], onDelete: Cascade)

  @@index([leaderId])
  @@index([status])
  @@index([createdAt])
}

// ==================== CHAT & NOTIFICATIONS ====================

// Chat Message model
model ChatMessage {
  id        String   @id @default(cuid())
  problemId String
  senderId  String
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  problem Problem @relation(fields: [problemId], references: [id], onDelete: Cascade)

  @@index([problemId])
  @@index([senderId])
}

// Notification model
model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String // REFERRAL, PAYMENT, HELP, SYSTEM, SECURITY, LEADER
  title     String
  message   String
  data      String? // JSON
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

// ==================== ADMIN & SECURITY ====================

// Admin audit log
model AdminLog {
  id         String   @id @default(cuid())
  adminId    String
  action     String // APPROVE_PAYMENT, BAN_USER, FLAG_FRAUD, etc.
  targetType String // USER, PAYMENT, PROBLEM, REPORT
  targetId   String?
  details    String?
  reason     String?
  ipAddress  String?
  createdAt  DateTime @default(now())

  @@index([adminId])
  @@index([createdAt])
  @@index([targetType, targetId])
}

// Security Audit - Comprehensive logging
model SecurityAudit {
  id     String  @id @default(cuid())
  userId String?

  eventType String // GPS_SPOOF, MULTI_ACCOUNT, FRAUD_ATTEMPT, SUSPICIOUS_LOGIN, DUPLICATE_UPI, etc.
  severity  String // INFO, WARNING, HIGH, CRITICAL

  // Event details
  description String
  metadata    String? // JSON

  // Location data if applicable
  lat Float?
  lng Float?

  // Device info
  deviceFingerprint String?
  ipAddress         String?
  userAgent         String?

  // Resolution
  resolved   Boolean   @default(false)
  resolvedBy String?
  resolvedAt DateTime?
  resolution String?

  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([eventType])
  @@index([severity])
  @@index([createdAt])
  @@index([resolved])
}

// SOS Alert model
model SosAlert {
  id           String    @id @default(cuid())
  userId       String
  problemId    String?
  lat          Float
  lng          Float
  message      String?
  status       String    @default("ACTIVE") // ACTIVE, RESOLVED, FALSE_ALARM
  resolvedBy   String?
  resolvedAt   DateTime?
  responseTime Int? // seconds until response
  createdAt    DateTime  @default(now())

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// Rate Limit model
model RateLimit {
  id         String   @id @default(cuid())
  identifier String // IP or User ID
  action     String // SEND_OTP, VERIFY_OTP, CREATE_PROBLEM, etc.
  count      Int      @default(1)
  resetAt    DateTime
  createdAt  DateTime @default(now())

  @@unique([identifier, action])
  @@index([resetAt])
}

// Content Filter - Banned words/categories
model ContentFilter {
  id        String   @id @default(cuid())
  type      String // WORD, CATEGORY, PATTERN
  value     String
  category  String? // illegal, dangerous, spam, inappropriate
  severity  String   @default("HIGH") // LOW, MEDIUM, HIGH, CRITICAL
  action    String   @default("BLOCK") // BLOCK, FLAG, REVIEW
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@unique([type, value])
  @@index([category])
}

// Admin Role - Role-based access
model AdminRole {
  id          String   @id @default(cuid())
  name        String   @unique // super_admin, admin, moderator, support
  permissions String // JSON array of permissions
  description String?
  createdAt   DateTime @default(now())

  assignments AdminAssignment[]

  @@index([name])
}

// Admin Assignment - User to Role mapping
model AdminAssignment {
  id         String   @id @default(cuid())
  userId     String
  roleId     String
  assignedBy String
  assignedAt DateTime @default(now())
  isActive   Boolean  @default(true)

  user User      @relation(fields: [userId], references: [id])
  role AdminRole @relation(fields: [roleId], references: [id])

  @@unique([userId, roleId])
  @@index([isActive])
}

// ==================== SYSTEM & STATS ====================

// System Settings model
model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt

  @@index([key])
}

// Daily Stats - For supply monitoring
model DailyStat {
  id       String  @id @default(cuid())
  date     String  @unique // YYYY-MM-DD
  areaCode String? // Optional area-specific stats

  // User stats
  newUsers    Int @default(0)
  activeUsers Int @default(0)
  paidUsers   Int @default(0)

  // Helper stats
  activeHelpers Int @default(0)
  totalHelps    Int @default(0)
  noShows       Int @default(0)

  // Problem stats
  problemsPosted        Int @default(0)
  problemsClosed        Int @default(0)
  starterTasksCompleted Int @default(0)

  // Financial
  paymentsPending  Int   @default(0)
  paymentsApproved Int   @default(0)
  revenue          Float @default(0)
  referralPayouts  Float @default(0)
  leaderCommission Float @default(0)

  // Security
  fraudAttempts   Int @default(0)
  accountsBanned  Int @default(0)
  reportsReceived Int @default(0)

  createdAt DateTime @default(now())

  @@index([date])
  @@index([areaCode])
}

// WhatsApp Notification model - For tracking notifications sent to paid users
model WhatsAppNotification {
  id        String @id @default(cuid())
  userId    String
  problemId String

  // Status tracking
  status      String    @default("PENDING") // PENDING, SENT, DELIVERED, FAILED, READ
  sentAt      DateTime?
  deliveredAt DateTime?
  readAt      DateTime?

  // Error handling
  errorMessage String?
  retryCount   Int     @default(0)

  // Notification content
  messageContent String? // The message that was sent

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, problemId])
  @@index([userId])
  @@index([problemId])
  @@index([status])
  @@index([createdAt])
}

// Helper Registration - First 5 helpers who tap "Ready to Help" get client phone
model HelperRegistration {
  id        String @id @default(cuid())
  problemId String
  helperId  String

  // Status
  status String @default("REGISTERED") // REGISTERED, CONTACTED, COMPLETED, CANCELLED

  // Ranking (first 5 get phone number)
  rank Int // 1-5 = gets phone number, 6+ = waitlist

  // Timestamps
  registeredAt DateTime  @default(now())
  contactedAt  DateTime? // When helper called the client

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([problemId, helperId])
  @@index([problemId])
  @@index([helperId])
  @@index([status])
  @@index([rank])
}

// ==================== WITHDRAWAL SYSTEM ====================

// Withdrawal Request - For referral earnings (min ₹200)
model WithdrawalRequest {
  id     String @id @default(cuid())
  userId String

  // Amount
  amount Float // Min ₹200
  status String @default("PENDING") // PENDING, APPROVED, REJECTED, PAID

  // Payment details
  upiId          String
  transactionRef String?

  // Admin
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// ==================== ESCROW WALLET SYSTEM ====================

// Escrow Transaction - Lock payment when task accepted
model EscrowTransaction {
  id        String @id @default(cuid())
  problemId String
  clientId  String // Task poster
  helperId  String // Task helper

  // Amount
  amount Float // Agreed payment amount

  // Status
  status String @default("LOCKED") // LOCKED, RELEASED, REFUNDED, DISPUTED

  // Lock details
  lockedAt     DateTime @default(now())
  lockExpiryAt DateTime // Auto-release after X hours

  // Release details
  releasedAt DateTime?
  releasedBy String? // User or Admin who released

  // Dispute
  disputeReason     String?
  disputeResolvedAt DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([problemId])
  @@index([clientId])
  @@index([helperId])
  @@index([status])
}

// ==================== USER VERIFICATION SYSTEM ====================

// User Verification - Verified badges
model UserVerification {
  id     String @id @default(cuid())
  userId String

  // Verification Types
  idVerified       Boolean @default(false) // Aadhaar/PAN verified
  businessVerified Boolean @default(false) // Business registration
  topPerformer     Boolean @default(false) // Top performer badge

  // ID Verification
  idType           String? // AADHAAR, PAN, PASSPORT
  idNumber         String? // Masked ID number
  idDocumentUrl    String? // Document image URL
  idVerifiedAt     DateTime?
  idRejectedReason String?

  // Business Verification
  businessName       String?
  businessType       String? // SHOP, SERVICE, FREELANCE
  businessAddress    String?
  businessDocUrl     String?
  businessVerifiedAt DateTime?

  // Top Performer Requirements
  totalHelps  Int   @default(0)
  avgRating   Float @default(0)
  weeklyHelps Int   @default(0)

  // Auto-qualification
  autoQualified Boolean   @default(false)
  qualifiedAt   DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId])
  @@index([idVerified])
  @@index([businessVerified])
  @@index([topPerformer])
}

// ==================== BOOST SYSTEM ====================

// Boost Purchase - ₹20 for visibility boost
model BoostPurchase {
  id     String @id @default(cuid())
  userId String

  // Boost Type
  boostType String // TASK_BOOST, PROFILE_BOOST
  targetId  String? // Problem ID for task boost

  // Payment
  amount        Float  @default(20) // ₹20 per boost
  paymentStatus String @default("PENDING") // PENDING, PAID, FAILED

  // Boost Duration
  durationHours Int       @default(24) // 24 hours visibility
  startsAt      DateTime?
  endsAt        DateTime?

  // Status
  isActive Boolean @default(false)

  // Priority (higher = more visible)
  priority Int @default(1) // 1-5, 5 being highest

  // Stats
  impressions Int @default(0) // How many times shown
  clicks      Int @default(0) // How many times clicked

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([boostType])
  @@index([isActive])
  @@index([endsAt])
}

// ==================== FEATURED ADS SYSTEM ====================

// Featured Advertisement - ₹999/month for shops
model FeaturedAd {
  id       String @id @default(cuid())
  userId   String
  areaCode String // Target area

  // Business Info
  businessName String
  businessType String // SHOP, SERVICE, RESTAURANT, etc.
  description  String?
  logoUrl      String?
  bannerUrl    String?

  // Contact
  phone   String
  address String?
  website String?

  // Subscription
  planType      String @default("MONTHLY") // MONTHLY, QUARTERLY, YEARLY
  amount        Float  @default(999)
  paymentStatus String @default("PENDING")

  // Duration
  startsAt DateTime?
  endsAt   DateTime?

  // Display
  isActive Boolean @default(false)
  priority Int     @default(1) // 1-3

  // Stats
  impressions Int @default(0)
  clicks      Int @default(0)
  leads       Int @default(0) // Contact clicks

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([areaCode])
  @@index([isActive])
  @@index([endsAt])
}

// ==================== WEEKLY LEADERBOARD ====================

// Weekly Leaderboard - Top earners
model WeeklyLeaderboard {
  id     String @id @default(cuid())
  userId String

  // Week identifier
  weekStart DateTime // Monday of the week
  weekEnd   DateTime // Sunday of the week

  // Stats for this week
  totalEarnings Float @default(0)
  totalHelps    Int   @default(0)
  avgRating     Float @default(0)

  // Rank
  rank Int // 1-5 for top earners

  // Rewards
  bonusAmount  Float   @default(0)
  badgeAwarded Boolean @default(false)
  bonusClaimed Boolean @default(false)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, weekStart])
  @@index([weekStart])
  @@index([rank])
  @@index([totalEarnings])
}

// ==================== LOGIN STREAK SYSTEM ====================

// Login Streak - Daily login rewards
model LoginStreak {
  id     String @id @default(cuid())
  userId String

  // Streak info
  currentStreak Int @default(0)
  longestStreak Int @default(0)

  // Last login
  lastLoginDate     DateTime?
  lastRewardClaimed DateTime?

  // Rewards earned
  totalRewards Int @default(0) // Non-monetary rewards count

  // Current reward
  currentReward String? // JSON: { type: "VISIBILITY_BOOST", duration: 24 }

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId])
  @@index([currentStreak])
}

// ==================== USER SKILLS SYSTEM ====================

// User Skills - Skill-based matching
model UserSkill {
  id     String @id @default(cuid())
  userId String

  // Skill info
  skillId   String // electrician, tutor, delivery, designer, etc.
  skillName String
  category  String // TECHNICAL, SERVICES, DELIVERY, TEACHING, CREATIVE

  // Experience level
  level           String @default("BEGINNER") // BEGINNER, INTERMEDIATE, EXPERT
  yearsExperience Int    @default(0)

  // Verification
  isVerified Boolean   @default(false)
  verifiedAt DateTime?

  // Stats
  totalJobs Int   @default(0)
  avgRating Float @default(0)

  // Availability
  isAvailable Boolean @default(true)
  hourlyRate  Float? // Optional hourly rate

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, skillId])
  @@index([skillId])
  @@index([category])
  @@index([isAvailable])
}

// ==================== AREA HEAT MAP ====================

// Area Demand Stats - For heat map
model AreaDemandStats {
  id       String @id @default(cuid())
  areaCode String

  // Time period
  date DateTime // Daily snapshot

  // Demand metrics
  totalRequests   Int @default(0) // Tasks posted
  totalHelpers    Int @default(0) // Helpers available
  avgResponseTime Int @default(0) // Minutes

  // Demand level (calculated)
  demandLevel String @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL

  // Supply gap (requests - helpers)
  supplyGap Int @default(0) // Positive = more demand

  // Category breakdown (JSON)
  categoryStats String? // { "EMERGENCY": 10, "TIME_ACCESS": 5, ... }

  // Metadata
  createdAt DateTime @default(now())

  @@unique([areaCode, date])
  @@index([areaCode])
  @@index([date])
  @@index([demandLevel])
}

// ==================== EARNINGS SUMMARY ====================

// Weekly Earnings Summary - For notifications
model WeeklyEarningsSummary {
  id     String @id @default(cuid())
  userId String

  // Week identifier
  weekStart DateTime
  weekEnd   DateTime

  // Earnings breakdown
  helpEarnings       Float @default(0)
  referralEarnings   Float @default(0)
  commissionEarnings Float @default(0)
  bonusEarnings      Float @default(0)
  totalEarnings      Float @default(0)

  // Activity
  helpsCompleted  Int   @default(0)
  referralsActive Int   @default(0)
  avgRating       Float @default(0)

  // Comparison with previous week
  weekOverWeekChange Float @default(0) // Percentage change

  // Notification
  notificationSent   Boolean   @default(false)
  notificationSentAt DateTime?

  // Metadata
  createdAt DateTime @default(now())

  @@unique([userId, weekStart])
  @@index([weekStart])
}
